{% extends "base_app.html" %}
{% load i18n %}
{% load static %}

{% block content %}
<div class="row justify-content-center mt-4">
    <div class="col-md-10 bg-light p-4 rounded shadow-sm">
        <div id="upload-container">
            <h4 class="mb-4 text-center">{% trans 'Качване и анализ на документ' %}</h4>
            <form id="uploadForm">
                {% csrf_token %}

                <div id="step1-selection" class="row justify-content-center">
                    <div class="col-md-10">
                        <div class="prescribed-by-container">
                            <select id="category" name="category" class="form-select custom-select-in-container">
                                <option value="" selected disabled>{% trans 'Категория...' %}</option>
                                <optgroup label="Резултати от изследвания">
                                    <option value="Кръвни изследвания">Кръвни изследвания</option>
                                    <option value="Изследване на урина">Изследване на урина</option>
                                    <option value="Микробиологично изследване">Микробиологично изследване</option>
                                    <option value="Резултат от биопсия">Резултат от биопсия</option>
                                </optgroup>
                                <optgroup label="Обобщени документи от лекар">
                                    <option value="Епикриза">Епикриза</option>
                                    <option value="Амбулаторен лист">Амбулаторен лист</option>
                                    <option value="Консултация">Консултация</option>
                                </optgroup>
                                <optgroup label="Образна и функционална диагностика">
                                    <option value="Рентгенова снимка">Рентгенова снимка</option>
                                    <option value="ЯМР">ЯМР</option>
                                    <option value="Скенер/КТ">Скенер/КТ</option>
                                    <option value="Ехография">Ехография</option>
                                    <option value="ЕКГ">ЕКГ</option>
                                    <option value="Запис на детски сърдечни тонове">Запис на детски сърдечни тонове</option>
                                </optgroup>
                                <optgroup label="Административни документи">
                                    <option value="Рецепта">Рецепта</option>
                                    <option value="Направление">Направление</option>
                                    <option value="Болничен лист">Болничен лист</option>
                                </optgroup>
                                <optgroup label="Други">
                                    <option value="Архив">Архив (Друг тип документ)</option>
                                </optgroup>
                            </select>

                            <span class="prescribed-by-text">{% trans 'назначено от' %}</span>

                            <select id="specialist" name="specialist" class="form-select custom-select-in-container">
                                <option value="" selected disabled>{% trans 'Специалист...' %}</option>
                                <option value="Мен">Мен (Лично изследване)</option>
                                <optgroup label="Общи и координиращи">
                                    <option value="Обща медицина">Обща (Семейна) медицина</option>
                                    <option value="Педиатрия">Педиатрия (Детски болести)</option>
                                </optgroup>
                                <optgroup label="Терапевтични">
                                    <option value="Вътрешни болести">Вътрешни болести</option>
                                    <option value="Кардиология">Кардиология</option>
                                    <option value="Ендокринология">Ендокринология</option>
                                    <option value="Гастроентерология">Гастроентерология</option>
                                    <option value="Пулмология">Пулмология (Белодробни болести)</option>
                                    <option value="Нефрология">Нефрология</option>
                                </optgroup>
                                <optgroup label="Хирургични">
                                    <option value="Хирургия">Хирургия</option>
                                    <option value="Ортопедия и травматология">Ортопедия и травматология</option>
                                    <option value="Урология">Урология</option>
                                    <option value="Акушерство и гинекология">Акушерство и гинекология (АГ)</option>
                                </optgroup>
                                <optgroup label="Други специализирани">
                                    <option value="Неврология">Неврология</option>
                                    <option value="Дерматология">Дерматология (Кожни болести)</option>
                                    <option value="УНГ">Уши, нос и гърло (УНГ)</option>
                                    <option value="Очни болести">Очни болести (Офталмология)</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="step2-upload" class="row justify-content-center mt-3" style="display: none;">
                    <div class="col-md-10">
                        <label for="file_input" class="form-label fw-bold visually-hidden">{% trans '3. Изберете файл:' %}</label>
                        <div class="input-group">
                             <input type="file" id="file_input" name="document" accept="image/*,application/pdf" class="form-control">
                             <button id="upload-ocr-button" type="button" class="btn btn-secondary" disabled>{% trans 'Качи за OCR' %}</button>
                        </div>
                    </div>
                </div>
            </form>

            <div id="step3-review" class="mt-4" style="display: none;">
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h5 class="text-center mb-2">Оригинален документ</h5>
                        <div id="preview-container" style="border: 1px solid #ccc; height: 500px; overflow: auto; background-color: #f8f9fa;">
                            <img id="image-preview" src="" alt="Image Preview" class="img-fluid" style="display: none;">
                            <embed id="pdf-preview" src="" type="application/pdf" width="100%" height="100%" style="display: none;"/>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-center mb-2">Разчетен текст за редакция</h5>
                        <p class="text-danger small">
                            <strong>Внимание:</strong> Моля, прочетете внимателно текста! Всяка неточност ще се отрази на крайния анализ.
                        </p>
                        <textarea id="ocr_text_area" class="form-control" style="height: 425px;"></textarea>
                        <button id="analyze-button" type="button" class="btn btn-primary w-100 mt-2">{% trans 'Одобри и анализирай с AI' %}</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="results-section" class="mt-4" style="display: none;">
            <hr>
            <h3 class="text-center">{% trans 'Резултати от анализа' %}</h3>
            <div id="result-summary" class="alert alert-info"></div>
            <div id="result-html-table" class="table-responsive"></div>
             <button onclick="window.location.reload();" class="btn btn-success mt-3">{% trans 'Качи нов документ' %}</button>
        </div>
    </div>
</div>

<script src="{% static 'js/upload_logic.js' %}" defer></script>
{% endblock %}